<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HireX | Aptitude Hub</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #D4AF37; --bg: #080808; --card: rgba(18,18,18,0.98); --border: rgba(212,175,55,0.25); --secure: #22c55e; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; min-height: 100vh; margin: 0; padding: 50px; background-image: radial-gradient(circle at top right, #151515, #080808); }
        .container { max-width: 1000px; margin: auto; text-align: center; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; margin-top: 50px; }
        
        .card { 
            background: var(--card); border: 1px solid var(--border); padding: 50px 30px; 
            border-radius: 30px; cursor: pointer; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative;
            overflow: hidden;
        }
        .card.completed { border-color: var(--secure); background: rgba(34, 197, 94, 0.03); box-shadow: 0 10px 30px rgba(34, 197, 94, 0.1); }
        .card:hover { transform: translateY(-10px); border-color: var(--gold); box-shadow: 0 15px 40px rgba(212, 175, 55, 0.15); }
        
        /* Shimmer effect for completed cards */
        .card.completed::after {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(34, 197, 94, 0.05), transparent);
            transform: rotate(45deg); animation: shimmer 3s infinite;
        }
        @keyframes shimmer { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }

        .status-icon { position: absolute; top: 20px; right: 20px; display: none; z-index: 2; }
        .completed .status-icon { display: block; color: var(--secure); }

        .deploy-zone { 
            margin-top: 80px; padding: 60px; border-radius: 40px;
            background: rgba(212, 175, 55, 0.03); border: 1px solid var(--gold);
            display: none; animation: fadeIn 0.8s ease; position: relative;
        }
        
        .btn-final { 
            background: linear-gradient(135deg, #D4AF37, #B8860B); color: black; 
            padding: 22px 80px; border-radius: 100px; font-weight: 900; border: none; 
            cursor: pointer; font-size: 1.1rem; letter-spacing: 2px; transition: 0.3s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        .btn-final:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(212, 175, 55, 0.4); }
        .btn-final:disabled { background: #333; color: #666; cursor: wait; transform: none; box-shadow: none; }
        
        .lock-msg { color: #555; margin-top: 30px; font-size: 0.85rem; letter-spacing: 2px; text-transform: uppercase; font-weight: 600; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <button onclick="location.href='faculty-dashboard.html'" style="background:none; border:none; color:var(--gold); cursor:pointer; float:left; display:flex; align-items:center; gap:8px; font-weight: 800; font-size: 0.8rem; text-transform: uppercase;">
            <i data-lucide="arrow-left" size="16"></i> Faculty Terminal
        </button>
        <br><br>
        
        <h2 style="font-family:'Playfair Display'; font-size: 3.5rem; margin-bottom: 10px; letter-spacing: -1px;">Assessment <span style="color:var(--gold)">Hub</span></h2>
        <p style="color: #666; font-size: 1.1rem; max-width: 600px; margin: 0 auto 50px auto;">Consolidate your aptitude modules into a single synchronized student assessment environment.</p>

        <div class="grid">
            <div class="card" id="card-quants" onclick="goToTest('quants')">
                <i class="status-icon" data-lucide="check-circle-2"></i>
                <i data-lucide="calculator" size="42" style="color:var(--gold); margin-bottom:20px;"></i>
                <h3 style="font-size: 1.4rem; margin-bottom:8px;">Quantitative</h3>
                <p id="status-quants" style="font-size: 0.8rem; color: #444; text-transform: uppercase; letter-spacing: 1px;">Awaiting Config</p>
            </div>

            <div class="card" id="card-logical" onclick="goToTest('logical')">
                <i class="status-icon" data-lucide="check-circle-2"></i>
                <i data-lucide="brain-circuit" size="42" style="color:var(--gold); margin-bottom:20px;"></i>
                <h3 style="font-size: 1.4rem; margin-bottom:8px;">Logical</h3>
                <p id="status-logical" style="font-size: 0.8rem; color: #444; text-transform: uppercase; letter-spacing: 1px;">Awaiting Config</p>
            </div>

            <div class="card" id="card-verbal" onclick="goToTest('verbal')">
                <i class="status-icon" data-lucide="check-circle-2"></i>
                <i data-lucide="message-square-quote" size="42" style="color:var(--gold); margin-bottom:20px;"></i>
                <h3 style="font-size: 1.4rem; margin-bottom:8px;">Verbal</h3>
                <p id="status-verbal" style="font-size: 0.8rem; color: #444; text-transform: uppercase; letter-spacing: 1px;">Awaiting Config</p>
            </div>
        </div>

        <div id="deployZone" class="deploy-zone">
            <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: var(--gold); color: black; padding: 5px 20px; border-radius: 20px; font-size: 0.7rem; font-weight: 900; letter-spacing: 1px;">READY FOR DEPLOYMENT</div>
            <h3 style="margin-bottom: 20px; font-family: 'Playfair Display'; font-size: 2rem;">Initialize Global Terminal</h3>
            <p style="color: #888; margin-bottom: 40px; font-size: 0.95rem;">All modules validated. Click below to merge and publish the assessment to students.</p>
            <button class="btn-final" id="deployBtn">DEPLOY TO STUDENTS</button>
        </div>
        
        <p id="lockMessage" class="lock-msg"><i data-lucide="lock" size="14" style="vertical-align: middle; margin-right: 5px;"></i> All modules must be finalized to unlock</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyB0aTzo7UoTRvYchcBQfy7eJZYl4S8vdTk", 
            authDomain: "hirex-73d04.firebaseapp.com", 
            projectId: "hirex-73d04", 
            storageBucket: "hirex-73d04.firebasestorage.app", 
            appId: "1:435154197357:web:5dbce3288c6a2771685864" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Updated Progress Check: Handles JSON objects correctly
        function checkProgress() {
            const modules = ['quants', 'logical', 'verbal'];
            let completedCount = 0;

            modules.forEach(m => {
                const rawData = localStorage.getItem('test_' + m);
                if (rawData) {
                    try {
                        // Whether it's the string "ready" or a full JSON string, we mark as completed
                        document.getElementById('card-' + m).classList.add('completed');
                        document.getElementById('status-' + m).innerText = 'Validated';
                        document.getElementById('status-' + m).style.color = '#22c55e';
                        completedCount++;
                    } catch(e) { console.error("Marker error", e); }
                }
            });

            if (completedCount === 3) {
                document.getElementById('deployZone').style.display = 'block';
                document.getElementById('lockMessage').style.display = 'none';
            }
        }

        window.goToTest = (type) => {
            window.location.href = `create-test.html?type=${type}`;
        };

        document.getElementById('deployBtn').onclick = async () => {
            const btn = document.getElementById('deployBtn');
            btn.innerHTML = `<i data-lucide="loader-2" class="spin"></i> MERGING CLOUD DATA...`;
            btn.disabled = true;
            lucide.createIcons();

            try {
                // FETCHING FRESH DATA FROM FIREBASE (Safer than LocalStorage)
                const fetchModule = async (cat) => {
                    const docRef = doc(db, "test_drafts", `draft_${cat}`);
                    const snap = await getDoc(docRef);
                    if (!snap.exists()) throw new Error(`${cat} draft not found on server!`);
                    return snap.data().questions;
                };

                const quantsQ = await fetchModule('quants');
                const logicalQ = await fetchModule('logical');
                const verbalQ = await fetchModule('verbal');

                const allQuestions = [...quantsQ, ...logicalQ, ...verbalQ];

                const finalAssessment = {
                    title: "HireX Global Aptitude Assessment",
                    totalQuestions: allQuestions.length,
                    duration: 60, 
                    questions: allQuestions,
                    status: "active",
                    createdAt: serverTimestamp(),
                    passScore: Math.floor(allQuestions.length * 0.6)
                };

                // PUSH TO THE OFFICIAL TESTS COLLECTION
                await addDoc(collection(db, "tests"), finalAssessment);
                
                alert("ðŸš€ SUCCESS! The combined assessment is now live for all students.");

                // Cleanup
                ['quants', 'logical', 'verbal'].forEach(m => localStorage.removeItem('test_' + m));
                window.location.href = 'faculty-dashboard.html';

            } catch (err) {
                console.error(err);
                alert("Deployment Error: " + err.message);
                btn.innerText = "INITIALIZE DEPLOYMENT";
                btn.disabled = false;
                lucide.createIcons();
            }
        };

        window.onload = checkProgress;
        lucide.createIcons();
    </script>
</body>
</html>