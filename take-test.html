<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HireX | Secure Terminal</title>
    <style>
        body { background: #000; color: #D4AF37; font-family: monospace; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .terminal-box { width: 90%; max-width: 500px; padding: 40px; border: 1px solid #D4AF37; background: #080808; border-radius: 20px; box-shadow: 0 0 30px rgba(212,175,55,0.1); }
        .alert { background: #ff4d4d; color: white; padding: 10px; width: 100%; position: fixed; top: 0; font-weight: bold; }
        input { width: 100%; padding: 15px; margin: 20px 0; background: #111; border: 1px solid #D4AF37; color: white; border-radius: 8px; outline: none; text-align: center; }
        .btn-submit { width: 100%; background: #D4AF37; color: black; border: none; padding: 15px; border-radius: 8px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body oncontextmenu="return false;">
<div class="alert">SECURITY PROTOCOL ACTIVE: DO NOT SWITCH TABS OR MINIMIZE WINDOW</div>
<div class="terminal-box">
    <h2 id="title">Loading Session...</h2>
    <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
    <p id="qText" style="font-size: 1.1rem; min-height: 50px;">Waiting for packet sync...</p>
    <input type="text" id="ans" placeholder="Enter Official Result">
    <button class="btn-submit" id="submitBtn">Submit To HireX</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyB0aTzo7UoTRvYchcBQfy7eJZYl4S8vdTk", authDomain: "hirex-73d04.firebaseapp.com", projectId: "hirex-73d04", storageBucket: "hirex-73d04.firebasestorage.app", appId: "1:435154197357:web:5dbce3288c6a2771685864" };
    const db = getFirestore(initializeApp(firebaseConfig));
    const auth = getAuth();
    const testId = new URLSearchParams(window.location.search).get("id");

    let currentTest = null;
    let submitted = false;
    let userData = null;

    onAuthStateChanged(auth, user => {
        if (!user) window.location.replace("slog.html");
        userData = user;
        loadSession();
    });

    // MALFUNCTION PROTECTION: Tab Switch Detection
    document.addEventListener("visibilitychange", () => {
        if (document.hidden && !submitted && currentTest) {
            alert("SECURITY VIOLATION: Tab switch detected. Auto-submitting with 0 score.");
            endExam(0, "TERMINATED: Tab Switch");
        }
    });

    async function loadSession() {
        if (!testId) return location.href = "student-dashboard.html";
        try {
            const d = await getDoc(doc(db, "tests", testId));
            // Ensure test is still active
            if (!d.exists() || d.data().status === "ended") {
                alert("Terminal Session Ended.");
                location.href = "student-dashboard.html";
                return;
            }
            currentTest = d.data();
            document.getElementById("title").innerText = currentTest.title;
            // Access 'question' from the first index of your questions array
            document.getElementById("qText").innerText = currentTest.questions[0].question;
        } catch (e) { alert("Sync Error."); }
    }

    async function endExam(finalScore, reason = "Normal") {
        if (submitted) return; 
        submitted = true;
        const btn = document.getElementById("submitBtn");
        btn.innerText = "UPLOADING...";
        btn.disabled = true;

        try {
            // Push results to 'submissions' collection
            await addDoc(collection(db, "submissions"), {
                testId,
                testTitle: currentTest.title,
                studentId: userData.uid,
                studentName: userData.email,
                score: finalScore,
                status: reason,
                timestamp: serverTimestamp()
            });
            alert("Transmission Complete. Result: " + finalScore + "%");
            window.location.replace("student-dashboard.html");
        } catch (e) {
            console.error(e);
            alert("Critical Transmission Failure.");
            submitted = false; // Allow retry if write fails
            btn.innerText = "Retry Upload";
            btn.disabled = false;
        }
    }

    document.getElementById("submitBtn").onclick = () => {
        const studentAns = document.getElementById("ans").value.trim().toLowerCase();
        const correctAns = currentTest.questions[0].answer.trim().toLowerCase();
        const score = (studentAns === correctAns) ? 100 : 0;
        endExam(score);
    };
</script>
</body>
</html>