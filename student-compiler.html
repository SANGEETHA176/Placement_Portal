<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HireX Terminal | Integrated Dev Environment</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #D4AF37;
            --bg: #050505;
            --panel: #0d0d0d;
            --border: #1a1a1a;
            --text: #e0e0e0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Top Bar */
        header { height: 60px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; }
        .timer { color: var(--gold); font-family: 'Fira Code', monospace; font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }

        /* Main Workspace */
        .workspace { flex: 1; display: flex; overflow: hidden; }

        /* Left: Problem Description */
        .problem-side { width: 40%; border-right: 1px solid var(--border); padding: 30px; overflow-y: auto; background: #080808; }
        .category-tag { color: var(--gold); font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; }
        h1 { font-size: 1.8rem; margin: 15px 0; color: white; }
        .description { line-height: 1.6; color: #aaa; margin-bottom: 30px; }
        .example-box { background: #111; padding: 15px; border-radius: 8px; border-left: 3px solid var(--gold); margin-bottom: 15px; }
        .example-box label { font-size: 0.7rem; color: var(--gold); display: block; margin-bottom: 5px; font-weight: 800; }

        /* Right: Editor Side */
        .editor-side { flex: 1; display: flex; flex-direction: column; background: #0c0c0c; }
        .editor-header { padding: 10px 20px; background: #111; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        
        #editor { flex: 1; font-family: 'Fira Code', monospace; padding: 20px; outline: none; background: transparent; color: #d4d4d4; resize: none; border: none; font-size: 1rem; line-height: 1.5; }

        /* Console/Output */
        .console { height: 200px; background: #050505; border-top: 2px solid var(--border); padding: 20px; font-family: 'Fira Code', monospace; font-size: 0.85rem; }
        .console-header { color: #555; margin-bottom: 10px; display: flex; justify-content: space-between; }

        /* Footer Buttons */
        .footer { padding: 15px 25px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 15px; background: var(--panel); }
        .btn { padding: 10px 25px; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.3s; border: none; }
        .btn-run { background: #1a1a1a; color: white; border: 1px solid #333; }
        .btn-submit { background: var(--gold); color: black; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: 800; letter-spacing: 2px; color: var(--gold);">HIREX TERMINAL v1.0</div>
        <div class="timer"><i data-lucide="clock"></i> <span id="time-left">00:00</span></div>
        <div id="student-name" style="font-size: 0.8rem; color: #555;">Verifying Session...</div>
    </header>

    <div class="workspace">
        <div class="problem-side">
            <span class="category-tag" id="difficulty">--</span>
            <h1 id="prob-title">Loading Mission...</h1>
            <div class="description" id="prob-desc">Fetching instructions from central database...</div>
            
            <div class="example-box">
                <label>EXAMPLE INPUT</label>
                <code id="ex-input">--</code>
            </div>
            <div class="example-box">
                <label>EXPECTED OUTPUT</label>
                <code id="ex-output">--</code>
            </div>
        </div>

        <div class="editor-side">
            <div class="editor-header">
                <select id="lang-select" style="background:#000; color:var(--gold); border:none; outline:none; font-weight:bold;">
                    <option value="python">Python 3</option>
                    <option value="java">Java</option>
                    <option value="cpp">C++</option>
                </select>
            </div>
            <textarea id="editor" spellcheck="false" placeholder="Write your logic here..."></textarea>
            
            <div class="console">
                <div class="console-header">
                    <span>SYSTEM_CONSOLE</span>
                    <span id="status-text" style="color: var(--gold);">Ready</span>
                </div>
                <div id="output" style="color: #666;">Execute code to see output...</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="btn btn-run" id="runBtn">RUN TESTS</button>
        <button class="btn btn-submit" id="submitBtn">SUBMIT FINAL MISSION</button>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyB0aTzo7UoTRvYchcBQfy7eJZYl4S8vdTk", 
        authDomain: "hirex-73d04.firebaseapp.com", 
        projectId: "hirex-73d04", 
        storageBucket: "hirex-73d04.firebasestorage.app", 
        appId: "1:435154197357:web:5dbce3288c6a2771685864" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const urlParams = new URLSearchParams(window.location.search);
    const testId = urlParams.get('id');
    let currentUserId = null;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            document.getElementById('student-name').innerText = user.email;
            loadTestDetails();
        } else {
            window.location.href = "flog.html";
        }
    });

    async function loadTestDetails() {
        if(!testId) return;
        const docRef = doc(db, "tests", testId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('prob-title').innerText = data.title;
            document.getElementById('prob-desc').innerText = data.description;
            document.getElementById('ex-input').innerText = data.exampleInput;
            document.getElementById('ex-output').innerText = data.exampleOutput;
            document.getElementById('difficulty').innerText = data.difficulty;
            startTimer(data.duration || 45);
        }
    }

    // --- REAL COMPILER LOGIC START ---
    document.getElementById('runBtn').onclick = async () => {
        const code = document.getElementById('editor').value;
        const language = document.getElementById('lang-select').value;
        const input = document.getElementById('ex-input').innerText;
        const outputDiv = document.getElementById('output');
        const statusText = document.getElementById('status-text');

        if(!code.trim()) { alert("Please write some code first!"); return; }

        statusText.innerText = "Compiling...";
        outputDiv.innerText = "Connecting to execution engine...";

        // Language version mapping for Piston API
        const versionMap = { "python": "3.10.0", "java": "15.0.2", "cpp": "10.2.0" };

        try {
            const response = await fetch("https://emkc.org/api/v2/piston/execute", {
                method: "POST",
                body: JSON.stringify({
                    language: language,
                    version: versionMap[language],
                    files: [{ content: code }],
                    stdin: input
                })
            });

            const result = await response.json();
            statusText.innerText = "Execution Finished";
            
            if (result.run.stderr) {
                outputDiv.style.color = "#ff4444"; // Red for errors
                outputDiv.innerText = result.run.stderr;
            } else {
                outputDiv.style.color = "#22c55e"; // Green for success
                outputDiv.innerText = result.run.output || "No output returned.";
                
                // Check if it matches expected output
                const expected = document.getElementById('ex-output').innerText.trim();
                if(result.run.output.trim() === expected) {
                    outputDiv.innerHTML += "<br><br><b style='color:gold;'>✅ Test Case Passed!</b>";
                } else {
                    outputDiv.innerHTML += `<br><br><b style='color:orange;'>❌ Output Mismatch. Expected: ${expected}</b>`;
                }
            }
        } catch (error) {
            outputDiv.innerText = "Error: Could not connect to Compiler API.";
            console.error(error);
        }
    };
    // --- REAL COMPILER LOGIC END ---

    document.getElementById('submitBtn').onclick = async () => {
        if(!confirm("Final submission? Your code will be evaluated.")) return;
        try {
            await addDoc(collection(db, "test_submissions"), {
                testId: testId,
                studentId: currentUserId,
                code: document.getElementById('editor').value,
                submittedAt: serverTimestamp(),
                status: "completed"
            });
            alert("Mission Successful!");
            window.location.href = "sdashboard.html";
        } catch (e) { alert("Error: " + e.message); }
    };

    function startTimer(mins) {
        let seconds = mins * 60;
        setInterval(() => {
            let m = Math.floor(seconds / 60);
            let s = Math.floor(seconds % 60);
            document.getElementById('time-left').innerText = `${m}:${s < 10 ? '0'+s : s}`;
            if (seconds-- <= 0) location.reload(); 
        }, 1000);
    }
</script>
</body>
</html>