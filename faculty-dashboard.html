<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HireX | Faculty Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --gold: #D4AF37; --bg: #080808; --card: rgba(20,20,20,0.9); --border: rgba(212,175,55,0.3); }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; }
        #protected-content { display: none; width: 100%; }
        .sidebar { width: 260px; height: 100vh; background: #0f0f0f; border-right: 1px solid var(--border); padding: 40px 20px; position: fixed; }
        .logo { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 2rem; margin-bottom: 50px; }
        .main { margin-left: 260px; padding: 50px; width: calc(100% - 260px); }
        .card { background: var(--card); border: 1px solid var(--border); padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        .btn-gold { background: linear-gradient(135deg, #D4AF37, #B8860B); color: black; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-block; }
        .test-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>
<div id="protected-content">
    <div class="sidebar">
        <div class="logo">HireX</div>
        <p style="color: var(--gold); font-size: 0.8rem; letter-spacing: 2px;">FACULTY PORTAL</p>
        <br>
        <button class="btn-gold" onclick="location.href='create-test.html'">+ Create Test</button>
        <br><br>
        <div id="logoutBtn" style="cursor:pointer; color:#A0A0A0;"><i data-lucide="log-out"></i> Logout</div>
    </div>
    <div class="main">
        <h1>Active Assessments</h1>
        <div class="card">
            <h3>Manage Tests</h3>
            <div id="test-list">Loading...</div>
        </div>
        <div class="card">
            <h3>Recent Submissions</h3>
            <div id="submission-list">No data yet.</div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyB0aTzo7UoTRvYchcBQfy7eJZYl4S8vdTk", authDomain: "hirex-73d04.firebaseapp.com", projectId: "hirex-73d04", storageBucket: "hirex-73d04.firebasestorage.app", messagingSenderId: "435154197357", appId: "1:435154197357:web:5dbce3288c6a2771685864" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
        if (!user) return window.location.replace("flog.html");
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.data().role !== "faculty") window.location.replace("flog.html");
        document.getElementById("protected-content").style.display = "flex";
        loadTests(user.uid);
        loadSubmissions();
    });

    async function loadTests(uid) {
        const q = query(collection(db, "tests"), where("createdBy", "==", uid));
        const snap = await getDocs(q);
        const list = document.getElementById("test-list");
        list.innerHTML = "";
        snap.forEach(d => {
            const t = d.data();
            list.innerHTML += `
                <div class="test-item">
                    <span>${t.title} (${t.status})</span>
                    <button class="btn-gold" style="padding:5px 10px; font-size:0.7rem;" onclick="endTest('${d.id}')">End Test</button>
                </div>`;
        });
    }

    window.endTest = async (id) => {
        await updateDoc(doc(db, "tests", id), { status: "ended" });
        alert("Test ended. Students can no longer access it.");
        location.reload();
    };

    async function loadSubmissions() {
        const snap = await getDocs(collection(db, "submissions"));
        const list = document.getElementById("submission-list");
        list.innerHTML = "";
        snap.forEach(d => {
            const s = d.data();
            list.innerHTML += `<div class="test-item">${s.studentName}: ${s.score}% on ${s.testTitle}</div>`;
        });
    }

    document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => location.replace("flog.html"));
    lucide.createIcons();
</script>
</body>
</html>